;; gorilla-repl.fileformat = 1

;; **
;;; # Random Fibonacci Number Example from Lecture 2
;; **

;; @@
(use 'nstools.ns)
(ns+ template
  (:like anglican-user.worksheet))
;; @@
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[nil,nil]"}
;; <=

;; **
;;; During the lecture, I explained how to write an Anglican query using the following very simple program.
;; **

;; @@
(defquery baby_rfib [n]
  (let [b     (sample (flip 0.5))
        new-n (if b n (+' n 1))]
    (loop [i  2 
           r0 1
           r1 1]
      (if (= i new-n)
        r1
        (recur (+' i 1)
               r1
               (+' r0 r1))))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;template/baby_rfib</span>","value":"#'template/baby_rfib"}
;; <=

;; **
;;; Before proceeding, let's use Anglican a little bit. We generate samples from the above Anglican query using the importance sampling algorithm. Then, we compute their mean, and compare it against the average of two corresponding fibonacci numbers.
;; **

;; @@
(def M 20)
(def samples_baby_rfib 
  (let [s (doquery :importance baby-rfib [m])]
    (map :result (take 1000 s))))

(def estimate_mean (float (mean samples_baby_rfib)))

(defn fib [n]
  (loop [i  2
         r0 1 
         r1 1]
    (if (= i n)
      r1
      (recur (+ i 1)
             r1
             (+ r0 r1)))))

(def true_mean (mean [(fib m) (fib (+ m 1))]))

(print (- estimate_mean true_mean))
;; @@
;; ->
;;; -33.4482421875
;; <-
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;template/m</span>","value":"#'template/m"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/samples_baby_rfib</span>","value":"#'template/samples_baby_rfib"}],"value":"[#'template/m,#'template/samples_baby_rfib]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/estimate_mean</span>","value":"#'template/estimate_mean"}],"value":"[[#'template/m,#'template/samples_baby_rfib],#'template/estimate_mean]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/fib</span>","value":"#'template/fib"}],"value":"[[[#'template/m,#'template/samples_baby_rfib],#'template/estimate_mean],#'template/fib]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/true_mean</span>","value":"#'template/true_mean"}],"value":"[[[[#'template/m,#'template/samples_baby_rfib],#'template/estimate_mean],#'template/fib],#'template/true_mean]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[#'template/m,#'template/samples_baby_rfib],#'template/estimate_mean],#'template/fib],#'template/true_mean],nil]"}
;; <=

;; **
;;; Now we implement the random Fibonacci sequence from the lecture.
;; **

;; @@
(defquery rfib [n]
  (loop [i  2
         r0 1
         r1 1]
    (if (= i n)
      r1
      (let [b  (sample (flip 0.5))
            r2 (if b (+' r1 r0) (-' r1 r0))]
        (recur (+ i 1)
               r1 
               r2)))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;template/rfib</span>","value":"#'template/rfib"}
;; <=

;; **
;;; 
;;; 
;; **

;; **
;;; We draw samples from the above Anglican query.
;; **

;; @@
(def M 70)
(def N 1000)

(def samples_rfib 
  (let [s (doquery :importance rfib [M])]
    (map :result (take N s))))

(plot/histogram samples_rfib
                :bins 50
                :normalize :probability)
;; @@
;; ->
;;; 1.130723653543264
;;; 0.002213230703412219
;;; 
;; <-
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;template/M</span>","value":"#'template/M"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/N</span>","value":"#'template/N"}],"value":"[#'template/M,#'template/N]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/samples_rfib</span>","value":"#'template/samples_rfib"}],"value":"[[#'template/M,#'template/N],#'template/samples_rfib]"},{"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c","values":[{"x":-8872895,"y":0},{"x":-8161078.72,"y":0.001},{"x":-7449262.4399999995,"y":0},{"x":-6737446.159999999,"y":0},{"x":-6025629.879999999,"y":0.001},{"x":-5313813.599999999,"y":0.001},{"x":-4601997.319999998,"y":0},{"x":-3890181.039999998,"y":0},{"x":-3178364.759999998,"y":0.001},{"x":-2466548.4799999977,"y":0.002},{"x":-1754732.1999999976,"y":0.001},{"x":-1042915.9199999976,"y":0.007},{"x":-331099.63999999757,"y":0.034},{"x":380716.64000000246,"y":0.913},{"x":1092532.9200000025,"y":0.023},{"x":1804349.2000000025,"y":0.007},{"x":2516165.4800000023,"y":0},{"x":3227981.7600000026,"y":0.005},{"x":3939798.040000003,"y":0.001},{"x":4651614.320000003,"y":0},{"x":5363430.600000003,"y":0.001},{"x":6075246.880000004,"y":0},{"x":6787063.160000004,"y":0},{"x":7498879.440000004,"y":0},{"x":8210695.720000004,"y":0},{"x":8922512.000000004,"y":0},{"x":9634328.280000003,"y":0},{"x":10346144.560000002,"y":0},{"x":11057960.840000002,"y":0},{"x":11769777.120000001,"y":0},{"x":12481593.4,"y":0},{"x":13193409.68,"y":0},{"x":13905225.959999999,"y":0},{"x":14617042.239999998,"y":0},{"x":15328858.519999998,"y":0},{"x":16040674.799999997,"y":0},{"x":16752491.079999996,"y":0},{"x":17464307.359999996,"y":0},{"x":18176123.639999997,"y":0.001},{"x":18887939.919999998,"y":0},{"x":19599756.2,"y":0},{"x":20311572.48,"y":0},{"x":21023388.76,"y":0},{"x":21735205.040000003,"y":0},{"x":22447021.320000004,"y":0},{"x":23158837.600000005,"y":0},{"x":23870653.880000006,"y":0},{"x":24582470.160000008,"y":0},{"x":25294286.44000001,"y":0},{"x":26006102.72000001,"y":0},{"x":26717919.00000001,"y":0.001},{"x":27429735.280000012,"y":0}]}],"marks":[{"type":"line","from":{"data":"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}],"value":"[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/abs_then_nroot</span>","value":"#'template/abs_then_nroot"}],"value":"[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/samples_rfib_processed</span>","value":"#'template/samples_rfib_processed"}],"value":"[[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot],#'template/samples_rfib_processed]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/mean_est</span>","value":"#'template/mean_est"}],"value":"[[[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_est]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/variance_est</span>","value":"#'template/variance_est"}],"value":"[[[[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_est],#'template/variance_est]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_est],#'template/variance_est],nil]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[[[[#'template/M,#'template/N],#'template/samples_rfib],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :values ({:x -8872895.0, :y 0} {:x -8161078.72, :y 0.001} {:x -7449262.4399999995, :y 0.0} {:x -6737446.159999999, :y 0.0} {:x -6025629.879999999, :y 0.001} {:x -5313813.599999999, :y 0.001} {:x -4601997.319999998, :y 0.0} {:x -3890181.039999998, :y 0.0} {:x -3178364.759999998, :y 0.001} {:x -2466548.4799999977, :y 0.002} {:x -1754732.1999999976, :y 0.001} {:x -1042915.9199999976, :y 0.007} {:x -331099.63999999757, :y 0.034} {:x 380716.64000000246, :y 0.913} {:x 1092532.9200000025, :y 0.023} {:x 1804349.2000000025, :y 0.007} {:x 2516165.4800000023, :y 0.0} {:x 3227981.7600000026, :y 0.005} {:x 3939798.040000003, :y 0.001} {:x 4651614.320000003, :y 0.0} {:x 5363430.600000003, :y 0.001} {:x 6075246.880000004, :y 0.0} {:x 6787063.160000004, :y 0.0} {:x 7498879.440000004, :y 0.0} {:x 8210695.720000004, :y 0.0} {:x 8922512.000000004, :y 0.0} {:x 9634328.280000003, :y 0.0} {:x 1.0346144560000002E7, :y 0.0} {:x 1.1057960840000002E7, :y 0.0} {:x 1.1769777120000001E7, :y 0.0} {:x 1.24815934E7, :y 0.0} {:x 1.319340968E7, :y 0.0} {:x 1.3905225959999999E7, :y 0.0} {:x 1.4617042239999998E7, :y 0.0} {:x 1.5328858519999998E7, :y 0.0} {:x 1.6040674799999997E7, :y 0.0} {:x 1.6752491079999996E7, :y 0.0} {:x 1.7464307359999996E7, :y 0.0} {:x 1.8176123639999997E7, :y 0.001} {:x 1.8887939919999998E7, :y 0.0} {:x 1.95997562E7, :y 0.0} {:x 2.031157248E7, :y 0.0} {:x 2.102338876E7, :y 0.0} {:x 2.1735205040000003E7, :y 0.0} {:x 2.2447021320000004E7, :y 0.0} {:x 2.3158837600000005E7, :y 0.0} {:x 2.3870653880000006E7, :y 0.0} {:x 2.4582470160000008E7, :y 0.0} {:x 2.529428644000001E7, :y 0.0} {:x 2.600610272000001E7, :y 0.0} {:x 2.671791900000001E7, :y 0.001} {:x 2.7429735280000012E7, :y 0})}], :marks [{:type \"line\", :from {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e83d9bd1-c9ef-4c57-8b0a-f10934e4cf2c\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_est],#'template/variance_est],nil],nil]"}
;; <=

;; @@
(defn compute_mean [xs]
  (/ (reduce +' 0.0 xs)
     (count xs)))

(defn compute_var [xs]
  (let [m  (compute_mean xs)
        f  (fn [x] (Math/pow (-' x m) 2))
        ys (map f xs)]
    (compute_mean ys)))

(def mean_est (compute_mean samples_rfib))
(def variance_est (compute_var samples_rfib))

(println "mean: " mean_est)
(println "variance: " variance_est)
(println)

(defn abs_then_nroot [x]
  (exp (/ (log (abs (float x))) M)))
(def samples_rfib_processed
  (map abs_then_nroot samples_rfib))
(def mean_vs_est 
  (compute_mean samples_rfib_processed))
(def variance_vs_est
  (compute_var samples_rfib_processed))

(println "vs mean: " mean_vs_est)
(println "vs variance: " variance_vs_est)
;; @@
;; ->
;;; mean:  35730.832
;;; variance:  1.3521962661831008E12
;;; 
;;; vs mean:  1.130723653543264
;;; vs variance:  0.002213230703412219
;;; 
;; <-
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;template/compute_mean</span>","value":"#'template/compute_mean"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/compute_var</span>","value":"#'template/compute_var"}],"value":"[#'template/compute_mean,#'template/compute_var]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/mean_est</span>","value":"#'template/mean_est"}],"value":"[[#'template/compute_mean,#'template/compute_var],#'template/mean_est]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/variance_est</span>","value":"#'template/variance_est"}],"value":"[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/abs_then_nroot</span>","value":"#'template/abs_then_nroot"}],"value":"[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/samples_rfib_processed</span>","value":"#'template/samples_rfib_processed"}],"value":"[[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot],#'template/samples_rfib_processed]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/mean_vs_est</span>","value":"#'template/mean_vs_est"}],"value":"[[[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_vs_est]"},{"type":"html","content":"<span class='clj-var'>#&#x27;template/variance_vs_est</span>","value":"#'template/variance_vs_est"}],"value":"[[[[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_vs_est],#'template/variance_vs_est]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_vs_est],#'template/variance_vs_est],nil]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[[[[[[[#'template/compute_mean,#'template/compute_var],#'template/mean_est],#'template/variance_est],nil],nil],nil],#'template/abs_then_nroot],#'template/samples_rfib_processed],#'template/mean_vs_est],#'template/variance_vs_est],nil],nil]"}
;; <=

;; @@

;; @@
